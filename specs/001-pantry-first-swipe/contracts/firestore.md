# Contracts â€” Firestore Writes (Swipe + Unlock)

These contracts define the required Firestore document shapes and atomic write sets for the pantry-first swipe engine.

## 1) Deck generation (initial + refill)

### Inputs

- Authenticated user `uid`
- Pantry items (>= 3 non-seasoning items)
- User preferences:
  - dietary restrictions
  - allergies
  - preferred cuisines (optional)
  - pantry discovery toggles:
    - includeBasics
    - willingToShop
- Energy level `energyLevel` in `0..4`

### Write set

When creating new previews, the client MUST:

1. Create `ideaKeyHistory` entries (idempotent)

- Path: `users/{uid}/ideaKeyHistory/e{energy}_{ideaKey}`
- Operation: `create` (preferred) or `set(..., merge: false)` if using deterministic conflict handling

2. Upsert swipe cards

- Path: `users/{uid}/swipeDeck/{recipeId}`
- Operation: `set(..., merge: true)`
- Required fields:
  - `ideaKey`, `energyLevel`, preview fields
  - `inputsSignature`, `promptVersion`
  - `isConsumed=false`

### Post-conditions

- Deck for each energy level contains at least 6 cards after first generation.
- When a deck reaches 3 remaining (unconsumed, not filtered out), a refill of 5 cards is attempted.

## 2) Marking swipe outcomes

### Left swipe (dislike)

- Path: `users/{uid}/swipeDeck/{recipeId}`
- Operation: `set(..., merge: true)`
- Required updates:
  - `isDisliked=true`
  - `isConsumed=false`
  - `lastSwipeDirection='left'`
  - `lastSwipedAt=serverTimestamp`

### Right swipe (unlock)

- Unlock is covered below; after a successful unlock transaction, the card is marked consumed.

## 3) Unlock (atomic spend + ledger + save)

### Inputs

- `uid`
- Deterministic `recipeId` (recommended: equals `ideaKey`)
- Full recipe payload generated by AI

### Transactional write set

A successful unlock MUST be a single Firestore transaction that writes all of:

1. User carrot decrement (free users)

- Path: `users/{uid}`
- Update:
  - `carrots.current = carrots.current - 1`
  - `stats.totalCarrotsSpent += 1`
  - `stats.recipesUnlocked += 1`

2. Immutable ledger entry

- Path: `users/{uid}/transactions/{recipeId}` (deterministic ID)
- Create:
  - `type='spend'`
  - `amount=-1`
  - `balanceAfter=<new balance>`
  - `recipeId=<recipeId>`
  - `timestamp=serverTimestamp`

3. Saved recipe (unlocked)

- Path: `users/{uid}/savedRecipes/{recipeId}`
- Create:
  - `isUnlocked=true`
  - `unlockedAt=serverTimestamp`
  - `unlockTxId=<recipeId>`
  - plus all recipe fields including `instructions`.

4. Consume swipe card

- Path: `users/{uid}/swipeDeck/{recipeId}`
- Update:
  - `isConsumed=true`
  - `consumedAt=serverTimestamp`
  - `lastSwipeDirection='right'`

### Failure modes

- Insufficient carrots: transaction aborts; no writes applied.
- AI generation fails: unlock transaction MUST NOT run; user is not charged.

## 4) Cache invalidation

### Inputs signature

- Stored at: `users/{uid}.appState.swipeInputsSignature`

### Invalidation rule

On any pantry add/remove/edit OR toggle change:

- Update `users/{uid}.appState.swipeInputsSignature` to a new value.

On Swipe entry:

- If signature mismatch is detected, clear `users/{uid}/swipeDeck/*` (best-effort) and regenerate.
- Do NOT clear `ideaKeyHistory`.

## 5) Weekly carrot reset (external automation)

The weekly carrot reset (Mondays 00:00 UTC) is handled externally (e.g., GitHub Actions/admin automation) and is not part of the pantry-first swipe client write contracts.

Requirements:

- The app MUST treat `users/{uid}.carrots.current` as a live value and react to external updates without requiring an app restart.
- Security: standard users MUST NOT be able to write increases to `carrots.current`. Admin automation should use Admin SDK (preferred) or a clearly distinguishable admin identity if rules enforcement is involved.
